# ADR 0003: Выбор БД и использование констрейнтов: PostgreSQL

## Статус
Принято

## Контекст
Нужно надежное хранилище истории запросов и статусов с консистентностью при конкурентных обновлениях одной валютной пары.

## Варианты

### 1. NoSQL (MongoDB / Cassandra)
*   **Плюсы**: Гибкая схема, масштабирование. Более простое шардирование при развитии сервиса.
*   **Минусы**: Сложнее обеспечить строгую согласованность, избыточно сейчас.

### 2. In-memory (Redis)
*   **Плюсы**: Максимальная скорость.
*   **Минусы**: Риск потери данных при сбоях.

### 3. PostgreSQL
*   **Плюсы**: ACID, типизация, индексы/констрейнты, надежность.
*   **Минусы**: Нужны миграции.

## Решение
Выбрана СУБД **PostgreSQL**.

## Почему
1.  ACID гарантирует корректные статусы при сбоях.
2.  `ENUM` предотвращает невалидные статусы.
3.  Дедупликация на уровне БД:
    *   Частичный уникальный индекс:
        ```sql
        CREATE UNIQUE INDEX uniq_quotes_pair_pending
        ON quotes(base, quote)
        WHERE status IN ('PENDING', 'RUNNING');
        ```
    *   Атомарная дедупликация через `INSERT ... ON CONFLICT`:
        ```sql
        INSERT INTO quotes (...) VALUES (...)
        ON CONFLICT (base, quote) WHERE status IN ('PENDING', 'RUNNING')
        DO UPDATE SET base = quotes.base -- no-op
        RETURNING id;
        ```
4.  Констрейнты `NOT NULL` и `CHECK` удерживают целостность данных.

## Последствия
*   Необходимость управления миграциями БД.
*   Гарантированная дедупликация задач на уровне хранилища, что разгружает внешних провайдеров.
